<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏÇ¨ÏÑúÌï® ÏÇ¨Ïö©Îüâ ÏõîÍ∞Ñ Ï†êÍ≤Ä(Î∂ôÏó¨ÎÑ£Í∏∞ Ï†ÑÏö©)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f0f2f5;
            color: #1a202c;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            padding: 25px;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 8px;
            color: #1a202c;
            font-weight: 700;
        }

        .subtitle {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 25px;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            font-size: 13px;
            font-weight: 600;
            color: #475569;
            margin-bottom: 6px;
        }

        .control-group input[type="number"],
        .control-group input[type="text"] {
            padding: 10px 14px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .control-group input:focus {
            outline: none;
            border-color: #6366f1;
        }

        .checkbox-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-wrapper input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-wrapper label {
            cursor: pointer;
            font-size: 14px;
            color: #334155;
            font-weight: 500;
        }

        textarea {
            width: 100%;
            min-height: 160px;
            padding: 16px;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
            transition: border-color 0.2s;
        }

        textarea:focus {
            outline: none;
            border-color: #6366f1;
            border-style: solid;
        }

        .button-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #6366f1;
            color: white;
            flex: 1;
            justify-content: center;
            font-size: 16px;
            padding: 14px 28px;
        }

        .btn-primary:hover {
            background: #4f46e5;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: #64748b;
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-action {
            background: #f8fafc;
            color: #334155;
            border: 1px solid #e2e8f0;
        }

        .btn-action:hover {
            background: #f1f5f9;
            border-color: #cbd5e0;
        }

        .summary-section {
            margin-bottom: 25px;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .summary-card {
            padding: 20px;
            border-radius: 12px;
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .summary-card.blue {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .summary-card.green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .summary-card.purple {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .summary-card.orange {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .summary-card.red {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .summary-card h3 {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            opacity: 0.95;
        }

        .summary-card .value {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .summary-card .subtext {
            font-size: 12px;
            margin-top: 4px;
            opacity: 0.9;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .result-title {
            font-size: 18px;
            font-weight: 700;
            color: #1a202c;
        }

        .result-actions {
            display: flex;
            gap: 8px;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            background: #f8fafc;
            color: #1e293b;
            padding: 14px 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }

        th:hover {
            background: #f1f5f9;
        }

        th.sorted-asc::after {
            content: " ‚ñ≤";
            font-size: 10px;
            color: #6366f1;
        }

        th.sorted-desc::after {
            content: " ‚ñº";
            font-size: 10px;
            color: #6366f1;
        }

        td {
            padding: 14px 12px;
            border-bottom: 1px solid #f1f5f9;
            color: #334155;
        }

        tbody tr:hover {
            background: #fafbfc;
        }

        tr.action-required {
            background: #fef2f2;
        }

        tr.action-required:hover {
            background: #fee2e2;
        }

        .text-right {
            text-align: right;
        }

        .text-center {
            text-align: center;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-yes {
            background: #fee2e2;
            color: #dc2626;
        }

        .badge-no {
            background: #d1fae5;
            color: #059669;
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #94a3b8;
            font-size: 15px;
        }

        .error-message {
            background: #fef2f2;
            color: #dc2626;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #dc2626;
            font-size: 14px;
        }

        .footer-note {
            text-align: center;
            font-size: 13px;
            color: #64748b;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0;
            }

            .card {
                padding: 20px;
                border-radius: 0;
            }

            .controls-grid {
                grid-template-columns: 1fr;
            }

            .summary-cards {
                grid-template-columns: 1fr;
            }

            .result-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .result-actions {
                width: 100%;
            }

            .result-actions button {
                flex: 1;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üìä ÏÇ¨ÏÑúÌï® ÏÇ¨Ïö©Îüâ ÏõîÍ∞Ñ Ï†êÍ≤Ä</h1>
            <p class="subtitle">ÏóëÏÖÄ Îç∞Ïù¥ÌÑ∞Î•º Î≥µÏÇ¨ÌïòÏó¨ Î∂ôÏó¨ÎÑ£Í≥† Í≥ÑÏÇ∞ÌïòÏÑ∏Ïöî</p>

            <div class="controls-grid">
                <div class="control-group">
                    <label for="allowedCapacity">ÌóàÏö©Îüâ (MB)</label>
                    <input type="number" id="allowedCapacity" value="6418944" min="0">
                </div>
                <div class="control-group">
                    <label for="addMB">Í∞ÄÏÇ∞ MB</label>
                    <input type="number" id="addMB" value="200" min="0">
                </div>
                <div class="control-group">
                    <label for="minSize">ÏµúÏÜå ÎåÄÏÉÅ ÏÇ¨ÏÑúÌï® ÌÅ¨Í∏∞(MB)</label>
                    <input type="number" id="minSize" value="5120" min="0">
                </div>
                <div class="control-group">
                    <label for="actionThreshold">Ï°∞Ïπò Í∏∞Ï§Ä ÏÇ¨Ïö©Î•†(%)</label>
                    <input type="number" id="actionThreshold" value="90" min="0" max="100">
                </div>
                <div class="control-group">
                    <label for="searchInput">Í≤ÄÏÉâ (Ïù¥Î¶Ñ/ÏÇ¨ÏÑúÌï®)</label>
                    <input type="text" id="searchInput" placeholder="Í≤ÄÏÉâÏñ¥ ÏûÖÎ†•...">
                </div>
            </div>

            <div class="checkbox-row">
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="capSize" checked>
                    <label for="capSize">ÏÇ¨ÏÑúÌï® ÌÅ¨Í∏∞ Ï¥àÍ≥º Ïãú Ï∫°</label>
                </div>
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="targetOnly" checked>
                    <label for="targetOnly">ÎåÄÏÉÅÎßå Î≥¥Í∏∞</label>
                </div>
            </div>

            <textarea id="pasteArea" placeholder="ÏóëÏÖÄ Îç∞Ïù¥ÌÑ∞Î•º Ïó¨Í∏∞Ïóê Î∂ôÏó¨ÎÑ£Í∏∞ÌïòÏÑ∏Ïöî (ÏòàÏãú):

Ïù¥Î¶Ñ	ÏÇ¨Ïö©Î•†(%)	ÏÇ¨ÏÑúÌï® ÌÅ¨Í∏∞(MB)	Ïã§ ÏÇ¨Ïö©Îüâ(MB)	ÏÇ¨ÏÑúÌï®
ÌôçÍ∏∏Îèô	95.0	44700	42373	honghong@kggroup.co.kr
ÍπÄÎëêÌïú	92.0	44066	40648	kdh@kggroup.co.kr
ÍπÄÏ≤†Ïàò	95.0	31091	29528	kcs1234@kggroup.co.kr
ÍπÄÎÇòÎØ∏	95.0	30100	28578	kimnami@kggroup.co.kr"></textarea>

            <div class="button-row">
                <button class="btn-primary" onclick="calculateData()">üìä Í≥ÑÏÇ∞ÌïòÍ∏∞</button>
                <button class="btn-secondary" onclick="clearPasteArea()">üóëÔ∏è Ï¥àÍ∏∞Ìôî</button>
            </div>

            <div id="errorMessage"></div>
        </div>

        <div id="summarySection"></div>

        <div id="resultSection"></div>

        <div class="footer-note">
            üîí Îç∞Ïù¥ÌÑ∞Îäî Î∏åÎùºÏö∞Ï†Ä Î©îÎ™®Î¶¨ÏóêÏÑúÎßå Ï≤òÎ¶¨ÎêòÎ©∞, Ïô∏Î∂ÄÎ°ú Ï†ÑÏÜ°ÎêòÏßÄ ÏïäÏäµÎãàÎã§.
        </div>
    </div>

    <script>
        let rawData = [];
        let processedData = [];
        let currentSort = { column: null, ascending: true };

        const columnAliases = {
            name: ['Ïù¥Î¶Ñ', 'name'],
            rate: ['ÏÇ¨Ïö©Î•†', 'ÏÇ¨Ïö©Î•†(%)', 'rate', 'usage'],
            size: ['ÏÇ¨ÏÑúÌï®ÌÅ¨Í∏∞(mb)', 'ÏÇ¨ÏÑúÌï® ÌÅ¨Í∏∞(mb)', 'ÌÅ¨Í∏∞', 'size'],
            used: ['Ïã§ÏÇ¨Ïö©Îüâ(mb)', 'Ïã§ ÏÇ¨Ïö©Îüâ(mb)', 'ÏÇ¨Ïö©Îüâ', 'used'],
            email: ['ÏÇ¨ÏÑúÌï®', 'Ïù¥Î©îÏùº', 'email', 'mailbox']
        };

        function normalizeHeader(header) {
            return header.toLowerCase().trim().replace(/\s+/g, '');
        }

        function findColumnIndex(headers, aliases) {
            const normalized = headers.map(h => normalizeHeader(h));
            for (let alias of aliases) {
                const normalizedAlias = normalizeHeader(alias);
                const index = normalized.indexOf(normalizedAlias);
                if (index !== -1) return index;
            }
            return -1;
        }

        function parseNumber(value) {
            if (value === null || value === undefined || value === '') return 0;
            const str = String(value).replace(/,/g, '').replace(/%/g, '').trim();
            const num = parseFloat(str);
            return isNaN(num) ? 0 : num;
        }

        function formatNumber(num) {
            return Math.round(num).toLocaleString('ko-KR');
        }

        function formatMB(num) {
            return formatNumber(Math.round(num)) + 'MB';
        }

        function parseData(text) {
            const lines = text.trim().split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                throw new Error('ÏµúÏÜå 2Ï§Ñ(Ìó§Îçî + Îç∞Ïù¥ÌÑ∞ 1Ï§Ñ) Ïù¥ÏÉÅ ÌïÑÏöîÌï©ÎãàÎã§.');
            }

            const delimiter = lines[0].includes('\t') ? '\t' : /\s{2,}|,/;
            const headers = lines[0].split(delimiter).map(h => h.trim());

            const nameIdx = findColumnIndex(headers, columnAliases.name);
            const rateIdx = findColumnIndex(headers, columnAliases.rate);
            const sizeIdx = findColumnIndex(headers, columnAliases.size);
            const usedIdx = findColumnIndex(headers, columnAliases.used);
            const emailIdx = findColumnIndex(headers, columnAliases.email);

            const missingColumns = [];
            if (nameIdx === -1) missingColumns.push('Ïù¥Î¶Ñ (Ïù∏Ïãù: ' + columnAliases.name.join(', ') + ')');
            if (sizeIdx === -1) missingColumns.push('ÏÇ¨ÏÑúÌï® ÌÅ¨Í∏∞ (Ïù∏Ïãù: ' + columnAliases.size.join(', ') + ')');
            if (usedIdx === -1) missingColumns.push('Ïã§ ÏÇ¨Ïö©Îüâ (Ïù∏Ïãù: ' + columnAliases.used.join(', ') + ')');
            if (emailIdx === -1) missingColumns.push('ÏÇ¨ÏÑúÌï® (Ïù∏Ïãù: ' + columnAliases.email.join(', ') + ')');

            if (missingColumns.length > 0) {
                throw new Error('ÌïÑÏàò Ïª¨Îüº ÎàÑÎùΩ: ' + missingColumns.join(', '));
            }

            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const cells = lines[i].split(delimiter).map(c => c.trim());
                if (cells.length < Math.max(nameIdx, sizeIdx, usedIdx, emailIdx) + 1) continue;

                const row = {
                    name: cells[nameIdx] || '',
                    originalRate: rateIdx !== -1 ? parseNumber(cells[rateIdx]) : 0,
                    size: parseNumber(cells[sizeIdx]),
                    used: parseNumber(cells[usedIdx]),
                    email: cells[emailIdx] || ''
                };

                if (row.name && row.size > 0) {
                    data.push(row);
                }
            }

            return data;
        }

        function calculateAdjustedData() {
            const addMB = parseNumber(document.getElementById('addMB').value);
            const minSize = parseNumber(document.getElementById('minSize').value);
            const actionThreshold = parseNumber(document.getElementById('actionThreshold').value);
            const capSize = document.getElementById('capSize').checked;

            return rawData.map(row => {
                let adjustedUsed = row.used + addMB;
                if (capSize && adjustedUsed > row.size) {
                    adjustedUsed = row.size;
                }

                const adjustedRate = row.size > 0 ? (adjustedUsed / row.size * 100) : 0;
                const isTarget = row.size > minSize;
                const needsAction = isTarget && adjustedRate >= actionThreshold;
                const remainingSpace = row.size - adjustedUsed;

                return {
                    ...row,
                    addMB: addMB,
                    adjustedUsed: adjustedUsed,
                    adjustedRate: Math.round(adjustedRate * 100) / 100,
                    remainingSpace: remainingSpace,
                    isTarget: isTarget,
                    needsAction: needsAction ? 'Ïòà' : 'ÏïÑÎãàÏò§'
                };
            });
        }

        function filterData(data) {
            const targetOnly = document.getElementById('targetOnly').checked;
            const searchText = document.getElementById('searchInput').value.toLowerCase().trim();

            return data.filter(row => {
                if (targetOnly && !row.isTarget) return false;
                if (searchText) {
                    const nameMatch = row.name.toLowerCase().includes(searchText);
                    const emailMatch = row.email.toLowerCase().includes(searchText);
                    if (!nameMatch && !emailMatch) return false;
                }
                return true;
            });
        }

        function sortData(data, column, ascending) {
            const sorted = [...data];
            sorted.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];

                if (typeof aVal === 'string') {
                    return ascending ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                } else {
                    return ascending ? aVal - bVal : bVal - aVal;
                }
            });
            return sorted;
        }

        function renderSummary(data) {
            const targetData = data.filter(row => row.isTarget);
            const actionRequired = targetData.filter(row => row.needsAction === 'Ïòà').length;
            
            const totalRemaining = targetData.reduce((sum, row) => sum + row.remainingSpace, 0);
            const avgRemaining = targetData.length > 0 ? (totalRemaining / targetData.length) : 0;
            
            const currentTotalUsage = targetData.reduce((sum, row) => sum + row.adjustedUsed, 0);
            const allowedCapacity = parseNumber(document.getElementById('allowedCapacity').value);
            const excessUsage = currentTotalUsage - allowedCapacity;

            const html = `
                <div class="summary-section">
                    <div class="summary-cards">
                        <div class="summary-card blue">
                            <h3>Ï≤òÎ¶¨ ÎåÄÏÉÅ</h3>
                            <div class="value">${formatNumber(targetData.length)}Í∞ú</div>
                        </div>
                        <div class="summary-card green">
                            <h3>Ï¥ù Í∞êÏÜåÎüâ</h3>
                            <div class="value">${formatMB(totalRemaining)}</div>
                            <div class="subtext">ÏûîÏó¨ Ïö©Îüâ Ìï©Í≥Ñ</div>
                        </div>
                        <div class="summary-card purple">
                            <h3>ÌèâÍ∑† Í∞êÏÜåÎüâ</h3>
                            <div class="value">${formatMB(avgRemaining)}</div>
                            <div class="subtext">ÌèâÍ∑† ÏûîÏó¨ Ïö©Îüâ</div>
                        </div>
                        <div class="summary-card orange">
                            <h3>ÌòÑÏû¨ Ï¥ù ÏÇ¨Ïö©Îüâ</h3>
                            <div class="value">${formatMB(currentTotalUsage)}</div>
                            <div class="subtext">ÌóàÏö©Îüâ: ${formatMB(allowedCapacity)}</div>
                        </div>
                        <div class="summary-card ${excessUsage > 0 ? 'red' : 'green'}">
                            <h3>${excessUsage > 0 ? 'Ï¥àÍ≥º ÏÇ¨Ïö©Îüâ' : 'Ïó¨Ïú† Ïö©Îüâ'}</h3>
                            <div class="value">${formatMB(Math.abs(excessUsage))}</div>
                            <div class="subtext">${excessUsage > 0 ? 'ÏÇ≠Ï†ú ÌïÑÏöî' : 'Ïó¨Ïú† ÏûàÏùå'}</div>
                        </div>
                        <div class="summary-card red">
                            <h3>Ï°∞Ïπò ÌïÑÏöî</h3>
                            <div class="value">${formatNumber(actionRequired)}Î™Ö</div>
                            <div class="subtext">90% Ïù¥ÏÉÅ ÏÇ¨Ïö©Ïûê</div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('summarySection').innerHTML = html;
        }

        function renderTable(data) {
            if (data.length === 0) {
                document.getElementById('resultSection').innerHTML = '';
                return;
            }

            const columns = [
                { key: 'name', label: 'Ïù¥Î¶Ñ' },
                { key: 'email', label: 'ÏÇ¨ÏÑúÌï®' },
                { key: 'size', label: 'ÏÇ¨ÏÑúÌï® ÌÅ¨Í∏∞(MB)', align: 'right' },
                { key: 'used', label: 'Ïã§ ÏÇ¨Ïö©Îüâ(MB)', align: 'right' },
                { key: 'addMB', label: 'Í∞ÄÏÇ∞(+MB)', align: 'right' },
                { key: 'adjustedUsed', label: 'Ï°∞Ï†ï_ÏÇ¨Ïö©Îüâ(MB)', align: 'right' },
                { key: 'remainingSpace', label: 'ÏûîÏó¨(MB)', align: 'right' },
                { key: 'adjustedRate', label: 'Ï°∞Ï†ï_ÏÇ¨Ïö©Î•†(%)', align: 'right' },
                { key: 'needsAction', label: 'Ï°∞Ïπò_ÌïÑÏöî', align: 'center' }
            ];

            let theadHtml = '<tr>';
            columns.forEach(col => {
                const sortClass = currentSort.column === col.key
                    ? (currentSort.ascending ? 'sorted-asc' : 'sorted-desc')
                    : '';
                theadHtml += `<th class="${sortClass}" onclick="handleSort('${col.key}')">${col.label}</th>`;
            });
            theadHtml += '</tr>';

            const fragment = document.createDocumentFragment();
            data.forEach(row => {
                const tr = document.createElement('tr');
                if (row.needsAction === 'Ïòà') {
                    tr.className = 'action-required';
                }

                columns.forEach(col => {
                    const td = document.createElement('td');
                    if (col.align) td.className = 'text-' + col.align;

                    let value = row[col.key];
                    if (col.key === 'size' || col.key === 'used' || col.key === 'addMB' || col.key === 'adjustedUsed' || col.key === 'remainingSpace') {
                        td.textContent = formatNumber(value);
                    } else if (col.key === 'adjustedRate') {
                        td.textContent = value.toFixed(1);
                    } else if (col.key === 'needsAction') {
                        const badge = document.createElement('span');
                        badge.className = value === 'Ïòà' ? 'badge badge-yes' : 'badge badge-no';
                        badge.textContent = value;
                        td.appendChild(badge);
                    } else {
                        td.textContent = value;
                    }

                    tr.appendChild(td);
                });

                fragment.appendChild(tr);
            });

            const resultHtml = `
                <div class="card">
                    <div class="result-header">
                        <div class="result-title">Ï≤òÎ¶¨ Í≤∞Í≥º</div>
                        <div class="result-actions">
                            <button class="btn-action" onclick="copyToClipboard()">üìã Î≥µÏÇ¨</button>
                            <button class="btn-action" onclick="downloadCSV()">üì• ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>${theadHtml}</thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            `;

            document.getElementById('resultSection').innerHTML = resultHtml;
            document.getElementById('tableBody').appendChild(fragment);
        }

        function handleSort(column) {
            if (currentSort.column === column) {
                currentSort.ascending = !currentSort.ascending;
            } else {
                currentSort.column = column;
                currentSort.ascending = true;
            }

            const filtered = filterData(processedData);
            const sorted = sortData(filtered, column, currentSort.ascending);
            renderTable(sorted);
        }

        function calculateData() {
            try {
                document.getElementById('errorMessage').innerHTML = '';
                const text = document.getElementById('pasteArea').value;

                if (!text.trim()) {
                    throw new Error('Î∂ôÏó¨ÎÑ£Í∏∞ ÏòÅÏó≠Ïù¥ ÎπÑÏñ¥ÏûàÏäµÎãàÎã§.');
                }

                rawData = parseData(text);
                processedData = calculateAdjustedData();

                const filtered = filterData(processedData);
                renderSummary(filtered);
                renderTable(filtered);
            } catch (error) {
                document.getElementById('errorMessage').innerHTML =
                    `<div class="error-message"><strong>‚ö†Ô∏è Ïò§Î•ò:</strong> ${error.message}</div>`;
                document.getElementById('summarySection').innerHTML = '';
                document.getElementById('resultSection').innerHTML = '';
            }
        }

        function clearPasteArea() {
            document.getElementById('pasteArea').value = '';
            document.getElementById('errorMessage').innerHTML = '';
            document.getElementById('summarySection').innerHTML = '';
            document.getElementById('resultSection').innerHTML = '';
            rawData = [];
            processedData = [];
            currentSort = { column: null, ascending: true };
        }

        function downloadCSV() {
            if (processedData.length === 0) {
                alert('Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
                return;
            }

            const filtered = filterData(processedData);
            let dataToExport = filtered;
            if (currentSort.column) {
                dataToExport = sortData(filtered, currentSort.column, currentSort.ascending);
            }

            const headers = ['Ïù¥Î¶Ñ', 'ÏÇ¨ÏÑúÌï®', 'ÏÇ¨ÏÑúÌï® ÌÅ¨Í∏∞(MB)', 'Ïã§ ÏÇ¨Ïö©Îüâ(MB)', 'Í∞ÄÏÇ∞(+MB)', 'Ï°∞Ï†ï_ÏÇ¨Ïö©Îüâ(MB)', 'ÏûîÏó¨(MB)', 'Ï°∞Ï†ï_ÏÇ¨Ïö©Î•†(%)', 'Ï°∞Ïπò_ÌïÑÏöî'];
            let csv = headers.join(',') + '\n';

            dataToExport.forEach(row => {
                const line = [
                    `"${row.name}"`,
                    `"${row.email}"`,
                    Math.round(row.size),
                    Math.round(row.used),
                    row.addMB,
                    Math.round(row.adjustedUsed),
                    Math.round(row.remainingSpace),
                    row.adjustedRate.toFixed(1),
                    `"${row.needsAction}"`
                ].join(',');
                csv += line + '\n';
            });

            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'ÏÇ¨ÏÑúÌï®_ÏÇ¨Ïö©Îüâ_Ï†êÍ≤Ä_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
        }

        function copyToClipboard() {
            if (processedData.length === 0) {
                alert('Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
                return;
            }

            const filtered = filterData(processedData);
            let dataToExport = filtered;
            if (currentSort.column) {
                dataToExport = sortData(filtered, currentSort.column, currentSort.ascending);
            }

            const headers = ['Ïù¥Î¶Ñ', 'ÏÇ¨ÏÑúÌï®', 'ÏÇ¨ÏÑúÌï® ÌÅ¨Í∏∞(MB)', 'Ïã§ ÏÇ¨Ïö©Îüâ(MB)', 'Í∞ÄÏÇ∞(+MB)', 'Ï°∞Ï†ï_ÏÇ¨Ïö©Îüâ(MB)', 'ÏûîÏó¨(MB)', 'Ï°∞Ï†ï_ÏÇ¨Ïö©Î•†(%)', 'Ï°∞Ïπò_ÌïÑÏöî'];
            let text = headers.join('\t') + '\n';

            dataToExport.forEach(row => {
                const line = [
                    row.name,
                    row.email,
                    Math.round(row.size),
                    Math.round(row.used),
                    row.addMB,
                    Math.round(row.adjustedUsed),
                    Math.round(row.remainingSpace),
                    row.adjustedRate.toFixed(1),
                    row.needsAction
                ].join('\t');
                text += line + '\n';
            });

            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.');
            }).catch(err => {
                alert('‚ùå Î≥µÏÇ¨ Ïã§Ìå®: ' + err);
            });
        }

        ['addMB', 'minSize', 'actionThreshold', 'allowedCapacity'].forEach(id => {
            document.getElementById(id).addEventListener('input', () => {
                if (rawData.length > 0) {
                    processedData = calculateAdjustedData();
                    const filtered = filterData(processedData);
                    renderSummary(filtered);
                    renderTable(filtered);
                }
            });
        });

        document.getElementById('capSize').addEventListener('change', () => {
            if (rawData.length > 0) {
                processedData = calculateAdjustedData();
                const filtered = filterData(processedData);
                renderSummary(filtered);
                renderTable(filtered);
            }
        });

        ['targetOnly', 'searchInput'].forEach(id => {
            const elem = document.getElementById(id);
            const event = id === 'searchInput' ? 'input' : 'change';
            elem.addEventListener(event, () => {
                if (processedData.length > 0) {
                    const filtered = filterData(processedData);
                    renderSummary(filtered);
                    renderTable(filtered);
                }
            });
        });
    </script>
</body>
</html>