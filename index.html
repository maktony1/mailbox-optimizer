<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>사서함 사용량 월간 점검(붙여넣기 전용)</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background:#f0f2f5; color:#1a202c; padding:20px; line-height:1.6;
    }
    .container { max-width:1600px; margin:0 auto; }
    .card {
      background:#fff; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.12);
      padding:25px; margin-bottom:20px;
    }
    h1 { font-size:24px; margin-bottom:8px; color:#1a202c; font-weight:700; }
    .subtitle { font-size:14px; color:#64748b; margin-bottom:25px; }
    .controls-grid {
      display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:15px; margin-bottom:20px;
    }
    .control-group { display:flex; flex-direction:column; }
    .control-group label { font-size:13px; font-weight:600; color:#475569; margin-bottom:6px; }
    .control-group input[type="number"]{
      padding:10px 14px; border:1px solid #e2e8f0; border-radius:6px; font-size:14px; transition:border-color 0.2s;
    }
    .control-group input:focus { outline:none; border-color:#6366f1; }
    .checkbox-wrapper { display:flex; align-items:center; gap:8px; margin-bottom:20px; }
    .checkbox-wrapper input[type="checkbox"]{ width:18px; height:18px; cursor:pointer; }
    .checkbox-wrapper label { cursor:pointer; font-size:14px; color:#334155; font-weight:500; }
    textarea{
      width:100%; min-height:160px; padding:16px; border:2px dashed #cbd5e0; border-radius:8px;
      font-family:'Courier New', monospace; font-size:13px; resize:vertical; transition:border-color 0.2s;
    }
    textarea:focus{ outline:none; border-color:#6366f1; border-style:solid; }
    .button-row{ display:flex; gap:10px; flex-wrap:wrap; }
    button{
      padding:12px 24px; border:none; border-radius:8px; font-size:14px; font-weight:600; cursor:pointer;
      transition:all 0.2s; display:inline-flex; align-items:center; gap:6px;
    }
    .btn-primary{ background:#6366f1; color:#fff; flex:1; justify-content:center; font-size:16px; padding:14px 28px; }
    .btn-primary:hover{ background:#4f46e5; transform:translateY(-1px); box-shadow:0 4px 12px rgba(99,102,241,0.4); }
    .btn-secondary{ background:#64748b; color:#fff; }
    .btn-secondary:hover{ background:#475569; }
    .btn-action{ background:#f8fafc; color:#334155; border:1px solid #e2e8f0; }
    .btn-action:hover{ background:#f1f5f9; border-color:#cbd5e0; }
    .summary-section{ margin-bottom:25px; }
    .summary-cards{ display:grid; grid-template-columns:repeat(auto-fit, minmax(240px,1fr)); gap:16px; }
    .summary-card{
      padding:24px; border-radius:12px; color:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }
    .summary-card.orange{ background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .summary-card.green{ background:linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .summary-card.red{ background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
    .summary-card.blue{ background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
    .summary-card h3{ font-size:13px; font-weight:600; margin-bottom:8px; opacity:0.95; }
    .summary-card .value{ font-size:28px; font-weight:700; letter-spacing:-0.5px; }
    .summary-card .subtext{ font-size:12px; margin-top:4px; opacity:0.9; }
    .result-header{
      display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; flex-wrap:wrap; gap:12px;
    }
    .result-title{ font-size:18px; font-weight:700; color:#1a202c; }
    .result-actions{ display:flex; gap:8px; }
    .table-container{ overflow-x:auto; border-radius:8px; border:1px solid #e2e8f0; }
    table{ width:100%; border-collapse:collapse; font-size:13px; }
    th{
      background:#f8fafc; color:#1e293b; padding:14px 12px; text-align:left; font-weight:600;
      border-bottom:2px solid #e2e8f0; cursor:pointer; user-select:none; white-space:nowrap;
    }
    th:hover{ background:#f1f5f9; }
    th.sorted-asc::after{ content:" ▲"; font-size:10px; color:#6366f1; }
    th.sorted-desc::after{ content:" ▼"; font-size:10px; color:#6366f1; }
    td{ padding:14px 12px; border-bottom:1px solid #f1f5f9; color:#334155; }
    tbody tr:hover{ background:#fafbfc; }
    tr.warning-row{ background:#fee2e2 !important; }
    tr.warning-row:hover{ background:#fecaca !important; }
    td.adjusted-used-cell{ background:#fed7aa; font-weight:600; }
    tr.warning-row td.adjusted-used-cell{ background:#fca5a5; }
    .text-right{ text-align:right; }
    .text-center{ text-align:center; }
    .no-data{ text-align:center; padding:60px 20px; color:#94a3b8; font-size:15px; }
    .error-message{
      background:#fef2f2; color:#dc2626; padding:16px; border-radius:8px; margin-bottom:20px;
      border-left:4px solid #dc2626; font-size:14px;
    }
    .footer-note{
      text-align:center; font-size:13px; color:#64748b; margin-top:20px; padding-top:20px; border-top:1px solid #e2e8f0;
    }
    @media (max-width: 768px){
      .container{ padding:0; }
      .card{ padding:20px; border-radius:0; }
      .controls-grid{ grid-template-columns:1fr; }
      .summary-cards{ grid-template-columns:1fr; }
      .result-header{ flex-direction:column; align-items:flex-start; }
      .result-actions{ width:100%; }
      .result-actions button{ flex:1; }
      table{ font-size:12px; }
      th, td{ padding:10px 8px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>📊 사서함 사용량 월간 점검</h1>
      <p class="subtitle">엑셀 데이터를 복사하여 붙여넣고 계산하세요</p>

      <div class="controls-grid">
        <div class="control-group">
          <label for="allowedCapacity">허용량 (MB)</label>
          <input type="number" id="allowedCapacity" value="6418944" min="0">
        </div>
        <div class="control-group">
          <label for="addMB">가산 MB</label>
          <input type="number" id="addMB" value="200" min="0">
        </div>
      </div>

      <div class="checkbox-wrapper">
        <input type="checkbox" id="capSize" checked>
        <label for="capSize">사서함 크기 초과 시 캡</label>
      </div>

      <textarea id="pasteArea" placeholder="엑셀 데이터를 여기에 붙여넣기하세요 (예시):

이름	사용률(%)	사서함 크기(MB)	실 사용량(MB)	사서함
홍길동	95.0	44700	42373	honghong@kggroup.co.kr
김두한	92.0	44066	40648	kdh@kggroup.co.kr
김철수	95.0	31091	29528	kcs1234@kggroup.co.kr
김나미	95.0	30100	28578	kimnami@kggroup.co.kr"></textarea>

      <div class="button-row">
        <button class="btn-primary" onclick="calculateData()">📊 계산하기</button>
        <button class="btn-secondary" onclick="clearPasteArea()">🗑️ 초기화</button>
      </div>

      <div id="errorMessage"></div>
    </div>

    <div id="summarySection"></div>
    <div id="resultSection"></div>

    <div class="footer-note">
      🔒 데이터는 브라우저 메모리에서만 처리되며, 외부로 전송되지 않습니다.
    </div>
  </div>

  <script>
    // ===== 상수 =====
    const BASE_MAILBOX_MB = 5120; // 사서함 크기가 0이 아닌 경우 최소 보정 기준

    // ===== 상태 =====
    let rawData = [];
    let processedData = [];
    let currentSort = { column: null, ascending: true };

    // ===== 컬럼 별칭 =====
    const columnAliases = {
      name: ['이름', 'name'],
      rate: ['사용률', '사용률(%)', 'rate', 'usage'],
      size: ['사서함크기(mb)', '사서함 크기(mb)', '크기', 'size'],
      used: ['실사용량(mb)', '실 사용량(mb)', '사용량', 'used'],
      email: ['사서함', '이메일', 'email', 'mailbox']
    };

    // ===== 유틸 =====
    function normalizeHeader(header){
      return header.toLowerCase().trim().replace(/\s+/g, '');
    }

    function findColumnIndex(headers, aliases){
      const normalized = headers.map(h => normalizeHeader(h));
      for(const alias of aliases){
        const idx = normalized.indexOf(normalizeHeader(alias));
        if(idx !== -1) return idx;
      }
      return -1;
    }

    function parseNumber(value){
      if(value === null || value === undefined || value === '') return 0;
      const str = String(value).replace(/,/g,'').replace(/%/g,'').trim();
      const num = parseFloat(str);
      return isNaN(num) ? 0 : num;
    }

    function formatNumber(num){
      return Math.round(num).toLocaleString('ko-KR');
    }

    function formatMB(num){
      return formatNumber(Math.round(num)) + 'MB';
    }

    function formatMBWithSign(num){
      const absNum = Math.abs(num);
      const formatted = formatNumber(Math.round(absNum)) + 'MB';
      return num < 0 ? '-' + formatted : formatted;
    }

    // ===== 파서 =====
    function parseData(text){
      const lines = text.trim().split('\n').filter(line => line.trim());
      if(lines.length < 2){
        throw new Error('최소 2줄(헤더 + 데이터 1줄) 이상 필요합니다.');
      }

      const delimiter = lines[0].includes('\t') ? '\t' : /\s{2,}|,/;
      const headers = lines[0].split(delimiter).map(h => h.trim());

      const nameIdx = findColumnIndex(headers, columnAliases.name);
      const rateIdx = findColumnIndex(headers, columnAliases.rate);
      const sizeIdx = findColumnIndex(headers, columnAliases.size);
      const usedIdx = findColumnIndex(headers, columnAliases.used);
      const emailIdx = findColumnIndex(headers, columnAliases.email);

      const missing = [];
      if(nameIdx === -1) missing.push('이름 (인식: ' + columnAliases.name.join(', ') + ')');
      if(sizeIdx === -1) missing.push('사서함 크기 (인식: ' + columnAliases.size.join(', ') + ')');
      if(usedIdx === -1) missing.push('실 사용량 (인식: ' + columnAliases.used.join(', ') + ')');
      if(emailIdx === -1) missing.push('사서함 (인식: ' + columnAliases.email.join(', ') + ')');

      if(missing.length > 0){
        throw new Error('필수 컬럼 누락: ' + missing.join(', '));
      }

      const data = [];
      for(let i=1;i<lines.length;i++){
        const cells = lines[i].split(delimiter).map(c => c.trim());
        if(cells.length < Math.max(nameIdx, sizeIdx, usedIdx, emailIdx) + 1) continue;

        const size = parseNumber(cells[sizeIdx]);
        const used = parseNumber(cells[usedIdx]);
        const originalRate = rateIdx !== -1 ? parseNumber(cells[rateIdx]) : 0;

        const row = {
          name: cells[nameIdx] || '',
          originalRate,
          size,
          used,
          email: cells[emailIdx] || ''
        };

        if(row.name || row.email) data.push(row);
      }

      return data;
    }

    // ===== 계산 =====
    function calculateAdjustedData(){
      const addMB = parseNumber(document.getElementById('addMB').value);
      const capOnOverflow = document.getElementById('capSize').checked;

      return rawData.map((row, index) => {
        let adjustedUsed;
        let isWarning = false;

        if(row.size === 0){
          // 크기 정보가 없는 특수 케이스: 원 사용량 유지 (가산 제외)
          adjustedUsed = row.used;
        } else {
          // 크기 > 0: 가산 적용 시도
          const tentative = row.used + addMB;

          if(tentative > row.size){
            // 초과
            isWarning = true;
            adjustedUsed = capOnOverflow ? row.size : row.used; // 캡 옵션
          } else {
            adjustedUsed = tentative;
          }

          // ✅ 핵심 요구사항: 크기 > 0 인 행에서 adjustedUsed < 5120이면 5120으로 보정
          if(adjustedUsed < BASE_MAILBOX_MB){
            adjustedUsed = BASE_MAILBOX_MB;
          }
        }

        const adjustedRate = row.size > 0 ? (adjustedUsed / row.size * 100) : 0;
        const remainingSpace = row.size > 0 ? Math.max(row.size - adjustedUsed, 0) : 0;

        return {
          ...row,
          rowNumber: index + 1,
          addMB: addMB,
          adjustedUsed: adjustedUsed,
          adjustedRate: Math.round(adjustedRate * 100) / 100,
          remainingSpace: remainingSpace,
          isWarning: isWarning
        };
      });
    }

    // ===== 정렬/렌더 =====
    function sortData(data, column, ascending){
      const sorted = [...data];
      sorted.sort((a,b) => {
        let av = a[column], bv = b[column];
        if(typeof av === 'string'){
          return ascending ? av.localeCompare(bv) : bv.localeCompare(av);
        }
        return ascending ? av - bv : bv - av;
      });
      return sorted;
    }

    function renderSummary(data){
      // 현재 총 사용량(용량 관점):
      // - 크기 0인 경우: 실사용량
      // - 그 외: 사서함 크기 기준(용량 점유 관점)
      let currentTotalUsage = 0;
      data.forEach(row => {
        currentTotalUsage += (row.size === 0 ? row.used : row.size);
      });

      const allowedCapacity = parseNumber(document.getElementById('allowedCapacity').value);
      const currentRemainingCapacity = allowedCapacity - currentTotalUsage;

      // 총 감소량: 각 사서함의 '잔여 공간' 합 (size - adjustedUsed)
      const totalReduction = data.reduce((sum, row) => sum + row.remainingSpace, 0);

      // 감소 후 여유 용량 = 현재 여유 + 총 감소량
      const remainingAfterReduction = currentRemainingCapacity + totalReduction;

      const html = `
        <div class="summary-section">
          <div class="summary-cards">
            <div class="summary-card blue">
              <h3>현재 총 사용량</h3>
              <div class="value">${formatMB(currentTotalUsage)}</div>
              <div class="subtext">허용량: ${formatMB(allowedCapacity)}</div>
            </div>
            <div class="summary-card ${currentRemainingCapacity >= 0 ? 'green':'red'}">
              <h3>현재 여유 용량</h3>
              <div class="value">${formatMBWithSign(currentRemainingCapacity)}</div>
              <div class="subtext">${currentRemainingCapacity >= 0 ? '여유 있음' : '초과 사용'}</div>
            </div>
            <div class="summary-card orange">
              <h3>총 감소량</h3>
              <div class="value">${formatMB(totalReduction)}</div>
              <div class="subtext">잔여 용량 합계</div>
            </div>
            <div class="summary-card ${remainingAfterReduction >= 0 ? 'green':'red'}">
              <h3>감소 후 여유용량</h3>
              <div class="value">${formatMBWithSign(remainingAfterReduction)}</div>
              <div class="subtext">${remainingAfterReduction >= 0 ? '여유 있음' : '추가 정리 필요'}</div>
            </div>
          </div>
        </div>
      `;
      document.getElementById('summarySection').innerHTML = html;
    }

    function renderTable(data){
      if(data.length === 0){
        document.getElementById('resultSection').innerHTML = '';
        return;
      }

      const columns = [
        { key:'rowNumber', label:'번호', align:'center' },
        { key:'name', label:'이름' },
        { key:'email', label:'사서함' },
        { key:'size', label:'사서함 크기(MB)', align:'right' },
        { key:'used', label:'실 사용량(MB)', align:'right' },
        { key:'addMB', label:'가산(+MB)', align:'right' },
        { key:'adjustedUsed', label:'조정_사용량(MB)', align:'right', highlight:true },
        { key:'remainingSpace', label:'잔여(MB)', align:'right' },
        { key:'adjustedRate', label:'조정_사용률(%)', align:'right' }
      ];

      let theadHtml = '<tr>';
      columns.forEach(col => {
        const sortClass = currentSort.column === col.key
          ? (currentSort.ascending ? 'sorted-asc' : 'sorted-desc')
          : '';
        theadHtml += `<th class="${sortClass}" onclick="handleSort('${col.key}')">${col.label}</th>`;
      });
      theadHtml += '</tr>';

      const fragment = document.createDocumentFragment();
      data.forEach(row => {
        const tr = document.createElement('tr');
        if(row.isWarning) tr.className = 'warning-row';

        columns.forEach(col => {
          const td = document.createElement('td');
          if(col.align) td.className = 'text-' + col.align;
          if(col.highlight) td.classList.add('adjusted-used-cell');

          const k = col.key;
          let value = row[k];

          if(k === 'rowNumber'){
            td.textContent = value;
          } else if(['size','used','addMB','adjustedUsed','remainingSpace'].includes(k)){
            td.textContent = formatNumber(value);
          } else if(k === 'adjustedRate'){
            td.textContent = value.toFixed(1);
          } else {
            td.textContent = value;
          }

          tr.appendChild(td);
        });

        fragment.appendChild(tr);
      });

      const resultHtml = `
        <div class="card">
          <div class="result-header">
            <div class="result-title">처리 결과 (총 ${data.length}명)</div>
            <div class="result-actions">
              <button class="btn-action" onclick="copyToClipboard()">📋 복사</button>
              <button class="btn-action" onclick="downloadCSV()">📥 엑셀 다운로드</button>
            </div>
          </div>
          <div class="table-container">
            <table>
              <thead>${theadHtml}</thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>
        </div>
      `;
      document.getElementById('resultSection').innerHTML = resultHtml;
      document.getElementById('tableBody').appendChild(fragment);
    }

    function handleSort(column){
      if(currentSort.column === column) currentSort.ascending = !currentSort.ascending;
      else { currentSort.column = column; currentSort.ascending = true; }

      const sorted = sortData(processedData, column, currentSort.ascending);
      renderTable(sorted);
    }

    // ===== 액션 =====
    function calculateData(){
      try{
        document.getElementById('errorMessage').innerHTML = '';
        const text = document.getElementById('pasteArea').value;
        if(!text.trim()) throw new Error('붙여넣기 영역이 비어있습니다.');

        rawData = parseData(text);
        processedData = calculateAdjustedData();

        renderSummary(processedData);
        renderTable(processedData);
      }catch(err){
        document.getElementById('errorMessage').innerHTML =
          `<div class="error-message"><strong>⚠️ 오류:</strong> ${err.message}</div>`;
        document.getElementById('summarySection').innerHTML = '';
        document.getElementById('resultSection').innerHTML = '';
        rawData = []; processedData = [];
      }
    }

    function clearPasteArea(){
      document.getElementById('pasteArea').value = '';
      document.getElementById('errorMessage').innerHTML = '';
      document.getElementById('summarySection').innerHTML = '';
      document.getElementById('resultSection').innerHTML = '';
      rawData = []; processedData = [];
      currentSort = { column:null, ascending:true };
    }

    function downloadCSV(){
      if(processedData.length === 0){ alert('데이터가 없습니다.'); return; }

      let dataToExport = processedData;
      if(currentSort.column){
        dataToExport = sortData(processedData, currentSort.column, currentSort.ascending);
      }

      const headers = ['번호','이름','사서함','사서함 크기(MB)','실 사용량(MB)','가산(+MB)','조정_사용량(MB)','잔여(MB)','조정_사용률(%)'];
      let csv = headers.join(',') + '\n';

      dataToExport.forEach(row => {
        const line = [
          row.rowNumber,
          `"${row.name}"`,
          `"${row.email}"`,
          Math.round(row.size),
          Math.round(row.used),
          row.addMB,
          Math.round(row.adjustedUsed),
          Math.round(row.remainingSpace),
          row.adjustedRate.toFixed(1)
        ].join(',');
        csv += line + '\n';
      });

      const blob = new Blob(['\uFEFF' + csv], { type:'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = '사서함_사용량_점검_' + new Date().toISOString().split('T')[0] + '.csv';
      link.click();
    }

    function copyToClipboard(){
      if(processedData.length === 0){ alert('데이터가 없습니다.'); return; }

      let dataToExport = processedData;
      if(currentSort.column){
        dataToExport = sortData(processedData, currentSort.column, currentSort.ascending);
      }

      const headers = ['번호','이름','사서함','사서함 크기(MB)','실 사용량(MB)','가산(+MB)','조정_사용량(MB)','잔여(MB)','조정_사용률(%)'];
      let text = headers.join('\t') + '\n';

      dataToExport.forEach(row => {
        const line = [
          row.rowNumber,
          row.name,
          row.email,
          Math.round(row.size),
          Math.round(row.used),
          row.addMB,
          Math.round(row.adjustedUsed),
          Math.round(row.remainingSpace),
          row.adjustedRate.toFixed(1)
        ].join('\t');
        text += line + '\n';
      });

      navigator.clipboard.writeText(text)
        .then(() => alert('✅ 클립보드에 복사되었습니다.'))
        .catch(err => alert('❌ 복사 실패: ' + err));
    }

    // 실시간 반영
    ['addMB','allowedCapacity'].forEach(id => {
      document.getElementById(id).addEventListener('input', () => {
        if(rawData.length > 0){
          processedData = calculateAdjustedData();
          renderSummary(processedData);
          renderTable(processedData);
        }
      });
    });

    document.getElementById('capSize').addEventListener('change', () => {
      if(rawData.length > 0){
        processedData = calculateAdjustedData();
        renderSummary(processedData);
        renderTable(processedData);
      }
    });
  </script>
</body>
</html>
